<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ResourceDao">

	<resultMap id="resourceResult" type="Resource">
		<id property="id" column="id" />
		<result property="nodeId" column="nodeId"/>
		<result property="type" column="type" />
		<result property="name" column="name" />
		<result property="keyWord" column="keyWord" />
		<result property="createTime" column="createTime" />
	</resultMap>

	<insert id="create">
		insert into media_resource (id,nodeId,type,name,keyWord,createTime) values (#{id},#{nodeId}, #{type}, #{name},#{keyWord}, now())
	</insert>

	<delete id="delete">
		delete from media_resource where id = #{id}
	</delete>

	<update id="update">
		UPDATE media_resource 
		<set>
			<if test="nodeId != null">
				nodeId = #{nodeId},
			</if>
			<if test="type != null">
				type = #{type},
			</if>
			<if test="name != null">
				name = #{name},
			</if>
			<if test="keyWord !=null ">
				keyWord = #{keyWord},
			</if>
		</set> 
		WHERE ID = #{id}
	</update>

	<select id="countByNodeId" resultType="Integer">
		select count(1) from media_resource where nodeId = #{nodeId}
	</select>
	
	<select id="find" resultMap="resourceResult">
		<bind name="namePattern" value="'%' + _parameter.getName() + '%'" />
		SELECT DISTINCT R.ID,R.NODEID, R.TYPE, R.NAME, R.KEYWORD, R.CREATETIME FROM media_resource R
		<where>
			<if test="nodeId != null and nodeId !='' ">
				R.NODEID = #{nodeId}
			</if>
			<if test="type != null and type !='' ">
				AND R.TYPE = #{type}
			</if>
			<if test="name != null  and name !='' and name.trim()!=''">
				AND R.NAME LIKE #{namePattern}
			</if>
			<if test="startTime != null and endTime != null and startTime.toString().trim()!='' and endTime.toString().trim()!=''">
				AND R.CREATETIME BETWEEN #{startTime} AND #{endTime}
			</if>
			<if test="tag != null and tag!='' and tag.trim()!=''">
				AND R.ID IN (SELECT RESOURCEID FROM media_resourcetag WHERE TAGID IN(SELECT ID FROM media_tag WHERE NAME = #{tag}))
			</if>
		</where>
	</select>
	
	<select id="findById" resultType="Resource">
		select id,nodeid,type,name,keyword,createtime from media_resource where id = #{id}
	</select>
	
</mapper>